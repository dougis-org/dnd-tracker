# Implementation Plan: User Profile & Settings Pages (F010)

**Branch**: `feature/010-user-profile-settings` | **Date**: 2025-11-11 | **Spec**: `specs/010-user-profile-settings/spec.md`  
**Maintainer**: @doug

---

## Summary

Feature 010 implements user-facing profile viewing/editing and settings management pages. Users will access `/profile` to view and edit their D&D preferences (experience level, preferred role, ruleset) and account information. A dedicated `/settings` page provides organized access to Account Settings, D&D Preferences, Notification Preferences (Email Notifications, Party Updates, Encounter Reminders toggles), and Data Management (export button).

**Technical Approach**:

- Mock user data adapter with in-memory/localStorage persistence (backend integration planned in F014 after Clerk auth)
- Optimistic UI updates with error recovery (change immediately, revert on failure)
- Form validation (RFC 5322 email, name 1-100 chars, enum-only D&D prefs) with inline error messages
- Skeleton loader during fetch, error banner with retry, empty state for new users
- TDD-first: write failing tests for each component/form logic before implementation
- Reuse shadcn/ui Button, Input, Select, Card components; extract form helpers as utilities

---

## Terminology & Naming Conventions

**Entity Naming** (consistency across spec, plan, and implementation):

| Term | Context | Usage |
|------|---------|-------|
| **User** | Entity concept | Database record; runtime entity. Used in narrative as standalone concept. |
| **UserProfile** | TypeScript Interface | Type definition in `src/types/user.ts`; component names like `ProfilePage`, `ProfileForm`. |
| **user profile** | Narrative / Prose | Lowercase in running text (e.g., "the user profile displays..."). |
| **UserPreferences** | TypeScript Interface | Type definition for D&D preferences; component `PreferencesSettings`. |
| **user preferences** | Narrative | Lowercase in running text. |
| **NotificationSettings** | TypeScript Interface & Component | Both capitalized as proper type/component name. |
| **Settings Page** / `/settings` | Routes & Page Names | Title case for prose; kebab-case for routes; PascalCase for component (SettingsPage.tsx). |

**Rationale**: Separates code (PascalCase/camelCase per TypeScript conventions) from narrative (lowercase for clarity and readability).

---

## Technical Context

**Language/Version**: TypeScript 5.9.2 (Next.js 16, React 19)  
**Primary Dependencies**: Next.js 16 (App Router), React 19, Tailwind CSS 4.x, shadcn/ui, Zod (validation), Jest 30.2, Playwright 1.56+  
**Storage**: In-memory mock adapter initially; later integrates with MongoDB Mongoose (F014)  
**Testing**: Jest (unit/integration) + Playwright (E2E). Target 80%+ coverage on new code.  
**Target Platform**: Web (Next.js 16 App Router)  
**Project Type**: Monolithic Next.js full-stack web application  
**Performance Goals**: Profile page loads < 1s, form saves < 500ms, validation inline < 200ms  
**Constraints**:

- Profile/Settings pages MUST redirect unauthenticated users to login (behavior mocked until F013 Clerk integration)
- All form changes use optimistic updates (no "loading" spinner blocking input)
- Accessibility: WCAG 2.1 AA compliance, keyboard navigation, screen reader labels
- File size: max 450 lines per component/service, max 50 lines per function
**Scale/Scope**: 2 pages (profile, settings), 5 form components (Profile, Preferences, Notifications, DataExport, Settings), ~1500 lines of production code + tests

---

## Constitution Check

✅ **PASS** (re-checked post-design)

### Checklist

- [x] `.specify/memory/constitution.md` referenced in feature spec (§ TDD, Quality & Ownership, Simplicity & Composability)
- [x] Quality & Ownership: TDD-first approach ensures all new code has failing tests before implementation
- [x] Test-First (TDD): Red → Green → Refactor cycle mandatory for all features and edge cases
- [x] Simplicity & Composability: Components kept under 50-line functions; form logic extracted to utilities
- [x] Observability & Security: Structured errors, meaningful validation messages, input sanitization via Zod
- [x] Versioning & Governance: No constitution amendments required for this feature

---

## Project Structure

### Documentation (this feature)

```text
specs/010-user-profile-settings/
├── plan.md              # This file (in-progress output)
├── research.md          # Phase 0 research findings (to be generated)
├── data-model.md        # Phase 1 data entities & relationships (to be generated)
├── quickstart.md        # Phase 1 developer quickstart (to be generated)
├── contracts/           # Phase 1 API contracts / OpenAPI (to be generated)
├── spec.md              # Original feature specification
└── tasks.md             # Phase 2 task checklist (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── app/
│   ├── profile/
│   │   └── page.tsx                 # ProfilePage component (root)
│   ├── settings/
│   │   └── page.tsx                 # SettingsPage component (root)
│   └── api/
│       └── user/                    # API routes (mocked initially)
│           ├── profile/
│           │   └── route.ts         # GET/PUT /api/user/profile
│           ├── preferences/
│           │   └── route.ts         # GET/PUT /api/user/preferences
│           └── notifications/
│               └── route.ts         # GET/PUT /api/user/notifications
│
├── components/
│   ├── profile/
│   │   ├── ProfilePage.tsx          # Page container
│   │   ├── ProfileForm.tsx          # Editable form (name, email, preferences)
│   │   ├── ProfileLoader.tsx        # Skeleton loader
│   │   ├── ProfileError.tsx         # Error banner with retry
│   │   └── ProfileEmpty.tsx         # Empty state for new users
│   │
│   └── settings/
│       ├── SettingsPage.tsx         # Page container
│       ├── SettingsNav.tsx          # Section tabs/navigation
│       ├── AccountSettings.tsx      # Account section
│       ├── PreferencesSettings.tsx  # D&D preferences section
│       ├── NotificationSettings.tsx # Notification preferences section
│       ├── DataManagement.tsx       # Data export section (stub)
│       └── SettingsError.tsx        # Error boundary
│
├── lib/
│   ├── adapters/
│   │   └── userAdapter.ts           # Mock user data service (optimistic updates)
│   ├── schemas/
│   │   └── userSchema.ts            # Zod validation schemas (email, name, prefs)
│   ├── validation/
│   │   └── userValidation.ts        # Validation utilities (RFC 5322, enum checks)
│   └── utils/
│       └── profileFormHelpers.ts    # Form state, error handling, optimistic updates
│
└── types/
    └── user.ts                      # User, Profile, Preferences TS interfaces
```

**Structure Decision**: Single Next.js web application (Option 2 for web application structure adapted to existing repo). Profile/Settings are lightweight pages sharing validation and adapter logic. API routes in `/api/user/*` support mock CRUD operations; later refactored to use Clerk + MongoDB (F014).

---

## Complexity Tracking

No constitution violations. All decisions justified by feature requirements and TDD mandate:

| Aspect | Decision | Rationale |
|--------|----------|-----------|
| Component modularity | ProfileForm, ProfileLoader, ProfileError kept < 50 lines; helpers extracted | Composability & testing isolation |
| Form state management | Optimistic updates via adapter; no Redux/Context | Simplicity; adapter is mocking layer, swappable post-F014 |
| Validation | Zod schemas co-located with types; used client-side + server-side | Single source of truth for validation rules |
| File organization | Forms, adapters, schemas separate; helpers re-used | DRY principle; easier to refactor after real persistence (F014) |

---

## Assumptions & Open Questions

### Assumptions

1. **Authentication**: Users are "logged in" for this phase (Clerk integration deferred to F013). Mock adapter assumes `userId` context available (e.g., from Next.js headers or localStorage fallback).
   - *See spec.md § Assumptions for full clarification details (Q: Security & data protection).*
2. **User Data Availability**: A `User` model will exist by F014; for now, mock adapter returns sample data for testing.
3. **Notification Toggles Scope**: Only 3 boolean toggles in first iteration (Email Notifications, Party Updates, Encounter Reminders). Frequency/digest options deferred.
   - *See spec.md § Assumptions (Q: Notification preferences scope).*
4. **Data Export**: Button visible & functional (API stub returns mock JSON). Real file download deferred to F048.
   - *See spec.md § Assumptions (Q: Data persistence pattern).*
5. **Error Handling**: Network errors show user-friendly banner with retry button. Validation errors display inline.
   - *See spec.md § Assumptions (Q: Error/loading states UX).*
6. **UI State**: Optimistic updates (disable save button, show loading spinner briefly, then success/error toast).
   - *See spec.md § Assumptions (Q: Data persistence pattern).*

### Open Questions Resolved in Spec Clarifications

- ✅ **Email Validation**: RFC 5322 format enforced via Zod
- ✅ **Name Constraints**: 1-100 characters, Unicode allowed
- ✅ **D&D Preference Enums**: Novice/Intermediate/Advanced, DM/Player/Both, 5e/3.5e/PF2e
- ✅ **Notification Preferences**: Boolean toggles (no frequency options this phase)
- ✅ **Optimistic Updates**: Yes; changes reflect immediately, revert on error
- ✅ **Loading States**: Skeleton on fetch, error banner on failure, empty state for new users
- ✅ **Security Deferral**: Audit logging and PII encryption deferred to F013/follow-up issue #425

---

## Acceptance Criteria (Normalized & Testable)

### AC-001: View User Profile (User Story 1, P1)

- **Given** user navigates to `/profile` **When** page loads **Then** all profile fields display with current user data  
- **Given** profile is loading **When** user sees page **Then** skeleton loader shows for 0.5–1s, then data appears  
- **Given** profile fetch fails **When** user is on `/profile` **Then** error banner appears with retry button  
- **Given** new user has no preferences **When** user views `/profile` **Then** empty state message guides them to settings  
- **Test**: `ProfilePage.test.tsx` — Verify component renders, data loads, skeleton/error/empty states  

### AC-002: Edit & Save Profile (User Story 2, P1)

- **Given** user edits name field on `/profile` **When** user clicks save **Then** change persists (mock: localStorage)  
- **Given** user changes D&D preferences **When** user refreshes page **Then** updated values remain (pessimistic read)  
- **Given** user enters invalid email **When** user tries to save **Then** inline error message appears (< 200ms)  
- **Given** save fails **When** user sees error toast **Then** form reverts to previous state (optimistic undo)  
- **Test**: `ProfileForm.test.tsx` — Happy path save, validation errors, error recovery  

### AC-003: Access Settings Page (User Story 3, P1)

- **Given** user navigates to `/settings` **When** page loads **Then** all sections visible (Account, Preferences, Notifications, Data)  
- **Given** settings page renders **When** user sees sections **Then** each section is properly labeled and interactive  
- **Test**: `SettingsPage.test.tsx` — Verify all sections render, tabs/navigation works  

### AC-004: Configure Notifications (User Story 4, P2)

- **Given** user is on `/settings` **When** user toggles Email Notifications **Then** UI state changes immediately (optimistic)  
- **Given** user saves notification preferences **When** user navigates away **Then** toggles persist  
- **Test**: `NotificationSettings.test.tsx` — Toggle state, save, persist across navigation  

### AC-005: Data Export (User Story 5, P2)

- **Given** user is on Data Management section **When** user sees export button **Then** button is visible and clickable  
- **Given** user clicks export **When** confirm dialog appears **Then** (stub) triggers download flow  
- **Test**: `DataManagement.test.tsx` — Export button visible, click handler called  

### AC-006: Authentication Redirect (Security)

- **Given** unauthenticated user tries `/profile` **When** access is attempted **Then** redirect to login (mocked: localStorage fallback)  
- **Given** unauthenticated user tries `/settings` **When** access is attempted **Then** redirect to login (mocked)  
- **Test**: E2E test verifies redirect (after F013 Clerk integration)  

### AC-007: Form Validation & Error Messaging

- **Given** user enters invalid email **When** field loses focus **Then** error message displays inline  
- **Given** user enters name > 100 chars **When** field loses focus **Then** error appears  
- **Given** user enters all valid data **When** user saves **Then** success toast appears and data persists  
- **Test**: `userValidation.test.ts` — Validate all enum values, email format, name length  

---

## Approach & Design Brief

### Design Principles

1. **Optimistic UI**: Changes reflect immediately; button disabled + loading spinner during save; revert on error.
2. **Progressive Enhancement**: Base form works without JS; enhanced with real-time validation and optimistic updates.
3. **Accessibility**: WCAG 2.1 AA—keyboard navigation, ARIA labels, error announcements.
4. **Mobile-First**: Responsive design using Tailwind; full-width on mobile, max-width on desktop.
5. **Component Isolation**: Each form/section is a standalone component; easier to test and refactor.

### Architecture Overview

```
┌─ ProfilePage (src/app/profile/page.tsx)
│  ├─ ProfileLoader (skeleton while fetching)
│  ├─ ProfileForm (name, email, preferences)
│  ├─ ProfileError (retry on failure)
│  └─ ProfileEmpty (guidance for new users)
│
└─ SettingsPage (src/app/settings/page.tsx)
   ├─ SettingsNav (section tabs)
   ├─ AccountSettings (account info section)
   ├─ PreferencesSettings (D&D prefs)
   ├─ NotificationSettings (toggle switches)
   └─ DataManagement (export button stub)

Shared Services:
├─ userAdapter.ts (mock CRUD: getProfile, updateProfile, getPreferences, etc.)
├─ userSchema.ts (Zod schemas for validation)
└─ profileFormHelpers.ts (optimistic state, error recovery)
```

### UI/UX Flow

**Profile Page Flow**:

1. Page loads → Fetch user data via adapter → Show skeleton
2. Data arrives → Render form with fields pre-populated
3. User edits field → Validation error (if invalid) shows inline
4. User clicks "Save" → Disable button, show spinner → Send to adapter
5. Success → Show toast, persist data, enable button
6. Error → Show toast + revert form, enable button

**Settings Page Flow**:

1. Page loads → Display all sections (Account, Preferences, Notifications, Data)
2. User interacts (toggle, select, input) → Change reflected immediately (optimistic)
3. User clicks "Save" → Send changes to adapter
4. Persist → Show success toast

### Data Model

**User Profile Entity**:

```typescript
interface UserProfile {
  id: string;                    // ObjectId-like or userId from Clerk
  name: string;                  // 1-100 chars, Unicode
  email: string;                 // RFC 5322 format
  createdAt: Date;
  updatedAt: Date;
}

interface UserPreferences {
  userId: string;
  experienceLevel: 'Novice' | 'Intermediate' | 'Advanced';
  preferredRole: 'DM' | 'Player' | 'Both';
  ruleset: '5e' | '3.5e' | 'PF2e';
}

interface NotificationSettings {
  userId: string;
  emailNotifications: boolean;
  partyUpdates: boolean;
  encounterReminders: boolean;
}
```

### Validation Rules (Zod Schemas)

```typescript
// Email: RFC 5322 simplified via regex
const emailSchema = z.string().email('Invalid email address');

// Name: 1-100 chars, allow Unicode
const nameSchema = z.string()
  .min(1, 'Name is required')
  .max(100, 'Name must be 100 characters or less');

// Preferences: enum-only
const preferencesSchema = z.object({
  experienceLevel: z.enum(['Novice', 'Intermediate', 'Advanced']),
  preferredRole: z.enum(['DM', 'Player', 'Both']),
  ruleset: z.enum(['5e', '3.5e', 'PF2e']),
});

// Notifications: boolean toggles
const notificationsSchema = z.object({
  emailNotifications: z.boolean(),
  partyUpdates: z.boolean(),
  encounterReminders: z.boolean(),
});
```

---

## Step-by-Step Implementation Plan (TDD-First)

### Phase 1: Schemas & Validation (Test-First)

**Step 1A**: Write failing tests for Zod schemas

- File: `tests/unit/schemas/userSchema.test.ts`
- Tests: Valid/invalid email, name length constraints, enum validation
- Status: Red (tests fail, schemas don't exist yet)

**Step 1B**: Implement Zod schemas in `src/lib/schemas/userSchema.ts`

- Define email, name, preferences, notifications schemas
- Status: Green (tests pass)

**Step 1C**: Write validation utility tests

- File: `tests/unit/lib/userValidation.test.ts`
- Tests: parseEmail(), validateName(), parsePreferences() functions
- Status: Red

**Step 1D**: Implement validation utilities in `src/lib/validation/userValidation.ts`

- Helper functions for client-side validation
- Status: Green

**Effort**: 2–3 hours (TDD cycle: write failing tests, implement)

---

### Phase 2: Mock Adapter & Data Layer (Test-First)

**Step 2A**: Write adapter tests

- File: `tests/integration/adapters/userAdapter.test.ts`
- Tests: getProfile(), updateProfile(), getPreferences(), updatePreferences(), getNotifications(), updateNotifications()
- Test both success and error paths (network timeout, validation error, etc.)
- Status: Red

**Step 2B**: Implement mock adapter in `src/lib/adapters/userAdapter.ts`

- Mock CRUD operations: use localStorage or in-memory store
- Simulate network delay (setTimeout for realism)
- Handle error scenarios (validation, fetch failure, etc.)
- Status: Green

**Step 2C**: Write form helper tests

- File: `tests/unit/lib/profileFormHelpers.test.ts`
- Tests: optimistic state management, error recovery, form reset
- Status: Red

**Step 2D**: Implement form helpers in `src/lib/utils/profileFormHelpers.ts`

- Optimistic update logic (apply change immediately, revert on error)
- Error message formatting
- Form state management utilities
- Status: Green

**Effort**: 3–4 hours (mocking, localStorage sync, error paths)

---

### Phase 3: Components — ProfilePage (TDD)

**Step 3A**: Write ProfilePage component tests

- File: `tests/unit/components/profile/ProfilePage.test.tsx`
- Tests:
  - Renders skeleton while loading
  - Renders form with user data on success
  - Renders error banner on fetch failure
  - Renders empty state for new users
  - Retry button calls fetch again
- Status: Red

**Step 3B**: Implement ProfilePage in `src/components/profile/ProfilePage.tsx`

- Root container; handles data fetching and error states
- Conditional rendering: loader, form, error, empty
- Uses adapter for data; passes to ProfileForm
- Status: Green

**Step 3C**: Write ProfileForm component tests

- File: `tests/unit/components/profile/ProfileForm.test.tsx`
- Tests:
  - Form fields pre-populated
  - Validation errors display inline on blur
  - Save button disabled during submission
  - Success toast on save
  - Error toast & form revert on failure
  - Optimistic updates
- Status: Red

**Step 3D**: Implement ProfileForm in `src/components/profile/ProfileForm.tsx`

- Editable form with name, email, preferences
- Real-time validation on blur
- Optimistic state + error recovery
- Uses profileFormHelpers for state logic
- Status: Green

**Step 3E**: Implement sub-components (loader, error, empty)

- `ProfileLoader.tsx` (skeleton)
- `ProfileError.tsx` (banner + retry)
- `ProfileEmpty.tsx` (guidance)
- Tests: one test per component verifying rendering
- Status: Green

**Effort**: 5–6 hours (component tests, integration with adapter, form logic)

---

### Phase 4: Components — SettingsPage (TDD)

**Step 4A**: Write SettingsPage tests

- File: `tests/unit/components/settings/SettingsPage.test.tsx`
- Tests:
  - All sections render (Account, Preferences, Notifications, Data)
  - Section navigation works (tabs)
  - Error boundary catches errors
- Status: Red

**Step 4B**: Implement SettingsPage in `src/components/settings/SettingsPage.tsx`

- Root container; renders sections
- Tabs/nav for section switching
- Status: Green

**Step 4C**: Write AccountSettings tests

- File: `tests/unit/components/settings/AccountSettings.test.tsx`
- Tests: Display account info (read-only or editable stub)
- Status: Red

**Step 4D**: Implement AccountSettings in `src/components/settings/AccountSettings.tsx`

- Display user name, email (read-only for now; edit link defers to profile page)
- Status: Green

**Step 4E**: Write PreferencesSettings tests

- File: `tests/unit/components/settings/PreferencesSettings.test.tsx`
- Tests:
  - Select dropdowns for experience level, role, ruleset
  - Save button persists changes
  - Validation on save
- Status: Red

**Step 4F**: Implement PreferencesSettings in `src/components/settings/PreferencesSettings.tsx`

- Three dropdown selects for D&D preferences
- Save logic reuses form helpers
- Status: Green

**Step 4G**: Write NotificationSettings tests

- File: `tests/unit/components/settings/NotificationSettings.test.tsx`
- Tests:
  - Toggle switches for 3 notification types
  - Toggles change immediately (optimistic)
  - Save button persists state
- Status: Red

**Step 4H**: Implement NotificationSettings in `src/components/settings/NotificationSettings.tsx`

- Three toggle switches (Email, Party Updates, Encounter Reminders)
- Optimistic state updates
- Status: Green

**Step 4I**: Write DataManagement tests

- File: `tests/unit/components/settings/DataManagement.test.tsx`
- Tests: Export button visible, click handler called (stub)
- Status: Red

**Step 4J**: Implement DataManagement in `src/components/settings/DataManagement.tsx`

- "Export Data" button (stub; real export deferred to F048)
- Status: Green

**Effort**: 5–6 hours (5 section components + tests)

---

### Phase 5: Page Routes & E2E Tests

**Step 5A**: Replace NotImplementedPage placeholders

- Update `src/app/profile/page.tsx` to render ProfilePage component
- Update `src/app/settings/page.tsx` to render SettingsPage component

**Step 5B**: Write E2E tests

- File: `tests/e2e/profile-settings.spec.ts`
- Tests:
  - Navigate to `/profile`, verify form loads
  - Edit name, save, verify persists
  - Navigate to `/settings`, verify all sections visible
  - Toggle notification, save, verify state
  - Invalid email shows error
  - Error recovery (retry on failure)
- Status: Red (pages not implemented)
- Status: Green (after pages implemented)

**Step 5C**: Run full test suite locally

- `npm run test:ci:parallel` (unit + integration)
- `npm run test:e2e` (E2E)
- Verify 80%+ coverage on new code

**Effort**: 2–3 hours (route swaps, E2E tests, coverage check)

---

### Phase 6: Review & Polish

**Step 6A**: Code review checklist

- [ ] All files < 450 lines
- [ ] All functions < 50 lines
- [ ] No `any` types
- [ ] Zod validation consistent
- [ ] Error messages user-friendly
- [ ] Accessibility: keyboard nav, ARIA labels, screen reader tested

**Step 6B**: Linting & formatting

- `npm run lint:fix`
- `npm run lint:markdown:fix`
- `npm run type-check`

**Step 6C**: Final test run

- `npm run test:ci:parallel` (must pass)
- `npm run test:e2e` (must pass)
- `npm run build` (must complete successfully)

**Effort**: 1–2 hours (polish, linting, final checks)

---

## Effort, Risks, and Mitigations

### Effort Estimate

- **Total**: 18–24 hours (compressed to ~2 days with parallel work)
- **Phase 1** (schemas): 2–3 hrs
- **Phase 2** (adapter): 3–4 hrs
- **Phase 3** (ProfilePage): 5–6 hrs
- **Phase 4** (SettingsPage): 5–6 hrs
- **Phase 5** (E2E & routes): 2–3 hrs
- **Phase 6** (polish): 1–2 hrs

### Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|-----------|
| **Scope creep**: Real data persistence (F014) blocked until Clerk/MongoDB ready | High | Medium | Deferred to F014; mock adapter standalone and swappable |
| **Optimistic updates race condition**: Concurrent saves conflict | Medium | High | Lock form during save; queue if multiple requests |
| **Validation mismatch**: Client vs. server validation differs | Medium | Medium | Zod schemas shared; reused on both sides (client pre-submit, server on real API) |
| **Form state explosion**: Complex form state becomes unmaintainable | Medium | Low | Extract helpers early (profileFormHelpers); reusable across settings sections |
| **Test maintenance**: Too many snapshot tests brittle to changes | Low | Low | Avoid snapshots; use semantic assertions (getByRole, etc.) |
| **Accessibility regression**: WCAG compliance missed | Low | High | Use axe-playwright in E2E; keyboard nav tested per component |

### Mitigations

1. **Lock & queue**: Disable save button during submission; queue if user tries to save again.
2. **Shared validation**: Zod schemas live in `src/lib/schemas/`; used client-side + (future) server-side.
3. **Incremental refactor**: Extract form logic to helpers as complexity grows; avoid premature generalization.
4. **A11y testing**: E2E includes axe-playwright accessibility audit; keyboard nav tested manually.
5. **Mock adapter**: Fully functional without F014 dependencies; can be swapped for real API later.

---

## File-Level Change List

### Files to Create (19 total)

**Data Layer (Schemas, Validation, Adapter)**:

1. `src/lib/schemas/userSchema.ts` — Zod schemas for user entities
2. `src/lib/validation/userValidation.ts` — Validation utility functions
3. `src/lib/adapters/userAdapter.ts` — Mock CRUD operations (localStorage-backed)
4. `src/lib/utils/profileFormHelpers.ts` — Form state, optimistic updates, error recovery
5. `src/types/user.ts` — TypeScript interfaces for User, Profile, Preferences, Notifications

**Components - Profile Page**:
6. `src/components/profile/ProfilePage.tsx` — Main page component (data fetching, conditional rendering)
7. `src/components/profile/ProfileForm.tsx` — Editable form (name, email, preferences)
8. `src/components/profile/ProfileLoader.tsx` — Skeleton loader
9. `src/components/profile/ProfileError.tsx` — Error banner with retry
10. `src/components/profile/ProfileEmpty.tsx` — Empty state for new users

**Components - Settings Page**:
11. `src/components/settings/SettingsPage.tsx` — Main page component (section nav)
12. `src/components/settings/SettingsNav.tsx` — Tab navigation (optional; inline in page if simple)
13. `src/components/settings/AccountSettings.tsx` — Account section (read-only or editable)
14. `src/components/settings/PreferencesSettings.tsx` — D&D preferences section
15. `src/components/settings/NotificationSettings.tsx` — Notification toggles section
16. `src/components/settings/DataManagement.tsx` — Data export section (stub)

**API Routes (Mock)**:
17. `src/app/api/user/profile/route.ts` — GET/PUT profile
18. `src/app/api/user/preferences/route.ts` — GET/PUT preferences
19. `src/app/api/user/notifications/route.ts` — GET/PUT notifications

### Files to Modify (2 total)

1. `src/app/profile/page.tsx` — Replace NotImplementedPage with ProfilePage component
2. `src/app/settings/page.tsx` — Replace NotImplementedPage with SettingsPage component

### Test Files to Create (13 total)

1. `tests/unit/schemas/userSchema.test.ts` — Zod validation tests
2. `tests/unit/lib/userValidation.test.ts` — Utility function tests
3. `tests/integration/adapters/userAdapter.test.ts` — Mock adapter CRUD tests
4. `tests/unit/lib/profileFormHelpers.test.ts` — Form state helper tests
5. `tests/unit/components/profile/ProfilePage.test.tsx` — ProfilePage render & state tests
6. `tests/unit/components/profile/ProfileForm.test.tsx` — Form edit & save tests
7. `tests/unit/components/profile/ProfileLoader.test.tsx` — Skeleton render test
8. `tests/unit/components/profile/ProfileError.test.tsx` — Error banner test
9. `tests/unit/components/profile/ProfileEmpty.test.tsx` — Empty state test
10. `tests/unit/components/settings/SettingsPage.test.tsx` — Settings page render test
11. `tests/unit/components/settings/PreferencesSettings.test.tsx` — Preferences section tests
12. `tests/unit/components/settings/NotificationSettings.test.tsx` — Notification toggles tests
13. `tests/e2e/profile-settings.spec.ts` — End-to-end workflow tests

**Total LOC (estimated)**:

- Production code: ~1200 LOC
- Test code: ~2000 LOC (80%+ coverage)
- Total: ~3200 LOC (reasonable for 2-day feature with TDD)

---

## Test Plan

### Unit Tests (Jest)

**Validation Layer**:

- `userSchema.test.ts`: Valid/invalid emails, names, enums
- `userValidation.test.ts`: Utility functions (parseEmail, validateName, etc.)
- Coverage: 100% (small, critical modules)

**Data Layer**:

- `userAdapter.test.ts`: getProfile(), updateProfile(), error handling, localStorage sync
- `profileFormHelpers.test.ts`: Optimistic state, error recovery, form reset
- Coverage: 85%+ (mocking layer; some paths require integration)

**Component Unit Tests**:

- Each component (ProfileForm, NotificationSettings, etc.) tested in isolation with mocked adapter
- Test happy path, validation errors, error states, loading states
- Coverage: 80%+

### Integration Tests

**Adapter Integration**:

- `tests/integration/adapters/userAdapter.test.ts`: Full CRUD flow (create, read, update, delete)
- Verify localStorage persistence works end-to-end

**Component + Adapter**:

- `tests/integration/profile-settings-flow.spec.tsx`: ProfileForm editing and save with real adapter
- Verify form state flows correctly through adapter

### E2E Tests (Playwright)

**Profile Page Flow**:

1. Navigate to `/profile`
2. Verify form loads with user data (from mock adapter)
3. Edit name field
4. Click Save → verify success toast
5. Refresh page → verify changes persist
6. Enter invalid email → verify error message
7. Click retry on error → verify retry works

**Settings Page Flow**:

1. Navigate to `/settings`
2. Verify all sections render (Account, Preferences, Notifications, Data)
3. Toggle Email Notifications → verify state change
4. Click Save → verify success toast
5. Navigate to `/profile` and back → verify notification state persisted

**Error Scenarios**:

- Network timeout on fetch → error banner, retry button
- Validation error on save → inline error message, form revert
- Concurrent saves → second save blocked or queued

**Accessibility**:

- Keyboard navigation (Tab, Shift+Tab, Enter)
- Screen reader labels (form fields, buttons, error messages)
- Color contrast, focus indicators

### Coverage Targets

- **New code**: 80%+ required per constitution
- **Schemas**: 100% (simple, critical)
- **Adapter**: 85%+ (mocking layer; some edge cases may be integration-only)
- **Components**: 80%+
- **Overall**: 80%+ on F010 code

---

## Rollout & Monitoring Plan

### Phased Rollout

**Phase 1 (Immediate)**:

- Deploy to `feature/010-user-profile-settings` branch
- Automated E2E tests run on PR
- Code review + Codacy analysis pass

**Phase 2 (After PR Merge)**:

- Merged to `main` branch
- GitHub Actions CI/CD pipeline runs (lint, tests, build)
- Deploy to staging (Fly.io preview environment) for manual QA

**Phase 3 (Production)**:

- Deploy to Fly.io production
- Monitor error logs for profile/settings endpoints
- Verify localStorage persistence works in production browsers

### Monitoring & Observability

**Error Tracking**:

- Log validation errors (invalid email, name too long, etc.) to console (future: external logging service)
- Log adapter errors (fetch timeout, parse error, etc.)
- Track failed saves for debugging

**Performance**:

- Monitor time to page load (target < 1s)
- Monitor time to first data render (< 500ms with skeleton)
- Monitor form save latency (< 500ms with optimistic updates)

**Accessibility**:

- Run axe-playwright on each page in E2E suite
- Monitor for a11y violations in logs

### Kill Switch & Rollback

- **Feature Flag** (future F047: Tier Limit Enforcement): Profile/Settings pages visible to all users (no flag).
- **Quick Rollback**: If critical issue found, revert to `NotImplementedPage` placeholder by reverting PR.
- **Data Integrity**: Mock adapter is ephemeral (localStorage); no risk of corruption. After F014 integration, Mongoose ensures schema validation.

---

## Handoff Package

### Deliverables

1. **Implementation branch**: `feature/010-user-profile-settings`
2. **Merged PR**: Linked to issue #364
3. **Documentation**:
   - This plan (`specs/010-user-profile-settings/plan.md`)
   - Quickstart guide (to be generated in Phase 1)
   - Data model diagram (to be generated in Phase 1)
4. **Code**:
   - All 19 component, service, and schema files
   - All 13 test files with 80%+ coverage
5. **CI/CD Status**:
   - ✅ All tests passing
   - ✅ TypeScript compilation successful
   - ✅ ESLint passes
   - ✅ Markdownlint passes (if markdown updated)
   - ✅ Codacy analysis passes (no new issues)

### Transition Notes (for F014 & F017)

**F014 (MongoDB User Model & Webhook)**:

- After F014, replace mock adapter (`userAdapter.ts`) with real MongoDB adapter
- Zod schemas in `src/lib/schemas/userSchema.ts` reusable for server-side validation
- Profile/Settings routes (`src/app/api/user/*`) will call real Mongoose models instead of mock

**F017 (Profile Page Functionality)**:

- Extend ProfileForm with more fields (profile picture, bio, etc.)
- Enhance error handling with audit logging
- Add security controls (email verification, PII encryption)

**F013 (Clerk Integration)**:

- Add Clerk auth middleware to redirect unauthenticated users (currently mocked)
- Extract userId from Clerk session instead of localStorage fallback
- Integrate Clerk user metadata with profile settings

### Known Limitations & Future Work

1. **Data Persistence**: Mock adapter uses localStorage; real backend deferred to F014.
2. **Data Export**: Button visible but non-functional; real file download deferred to F048.
3. **Security**: Audit logging and PII encryption deferred to F013/follow-up #425.
4. **Notifications**: Only 3 boolean toggles; frequency/digest options deferred.
5. **Profile Picture**: Not included in this phase; deferred to later feature.

### Success Criteria (Feature Complete)

- ✅ All user stories (1–5) have passing E2E tests
- ✅ Form validation works per acceptance criteria
- ✅ Optimistic updates + error recovery functional
- ✅ 80%+ test coverage on new code
- ✅ Accessibility: WCAG 2.1 AA compliance verified
- ✅ Build passes: `npm run build` completes
- ✅ All linting checks pass
- ✅ Code review approved
- ✅ Codacy analysis passes
- ✅ Deployed to staging and tested manually

---

## Appendix: Decision Log

### Decision: Optimistic Updates vs. Pessimistic

**Chosen**: Optimistic updates (change immediately, revert on error)  
**Rationale**: Better UX (no perceived delay), matches spec requirement ("reflect changes immediately"). Form locked during save to prevent race conditions.  
**Alternative Rejected**: Pessimistic (wait for server confirmation) — would require loading spinner blocking input, poor UX.

### Decision: Mock Adapter vs. Real Backend Dependency

**Chosen**: Mock adapter (localStorage-backed); real backend integration in F014  
**Rationale**: Unblocks F010 development (F014 not yet started). Adapter pattern allows clean swap later. Testable in isolation.  
**Alternative Rejected**: Wait for F014 — extends timeline; blocks E2E testing.

### Decision: Zod Schemas Placement

**Chosen**: `src/lib/schemas/userSchema.ts` (shared, client-side + future server-side)  
**Rationale**: Single source of truth for validation rules. Reusable in server routes after F014.  
**Alternative Rejected**: Inline validation in components — violates DRY; harder to test; duplicate logic.

### Decision: Form State Management (No Redux/Context)

**Chosen**: Local `useState` + adapter + form helpers  
**Rationale**: Profile/Settings forms are lightweight; no cross-page state sharing needed. Simpler than Redux for this scope. Easy to refactor if needed.  
**Alternative Rejected**: Redux/Zustand — overkill for current requirements; adds complexity; could add later if needed.

### Decision: Component File Organization

**Chosen**: `/components/profile/` and `/components/settings/` with sub-components (Form, Loader, Error, Empty)  
**Rationale**: Co-locate related components; easy to find; each < 50 lines per function.  
**Alternative Rejected**: Flat structure under `/components/` — harder to navigate as more components added.

---

**Plan Status**: ✅ Ready for Phase 0 Research  
**Next Step**: Generate `research.md` with any clarifications needed; then proceed to Phase 1 Design (data-model.md, contracts/).
