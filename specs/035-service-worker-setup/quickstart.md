# Quickstart: Service Worker Integration

Path: `/specs/035-service-worker-setup`

This quickstart explains the minimal steps to register the service worker and integrate the offline queue and update flow.

1. Register the service worker during app startup (client-side):

```js
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/sw.js');
      console.debug('Service worker registered', reg);
      // optional: listen for updates
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // handle controller change
      });
    } catch (err) {
      console.warn('SW registration failed', err);
    }
  });
}
```

2. Implement an `sw.js` with these responsibilities:

- Precache the app shell on `install` (use content-hash filenames generated by the build)
- Implement runtime caching: `cache-first` for static assets, `network-first` for API endpoints
- Maintain named runtime caches with size cap and approximate LRU eviction
- Implement an `IndexedDB` offline-queue consumer that retries on `online` event
- Emit lifecycle messages to clients via `postMessage` for UI updates (install, activate, update-available, sync-progress)

3. UI integration:

- Show a non-blocking offline banner on `navigator.onLine === false` or when the service worker posts an `offline` message.
- When an update is available (service worker sends `update-available`), show a banner with `Refresh` control. If user dismisses, auto-activate after safe window (24h).

4. Queued operations:

- Persist `OfflineQueueEntry` in IndexedDB.
- On `online`, process queue items with exponential backoff up to 5 attempts, then surface failure for manual retry.
- Prefer sending batched operations to server endpoint `POST /sync/offline-ops` (see contracts) for efficient processing.

5. Security notes:

- Do not store auth tokens or PII in caches. Attach auth tokens in requests at runtime (client fetch) rather than from the service worker.
- Encrypt sensitive fields in queued payloads before storage using Web Crypto (AES-GCM).

6. Test hints:

- Use Playwright headful runs to validate SW lifecycle in CI.
- Simulate offline/online transitions in browser devtools and assert offline banner timing and queue retries.
