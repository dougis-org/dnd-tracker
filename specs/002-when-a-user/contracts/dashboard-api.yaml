openapi: 3.0.0
info:
  title: Dashboard Metrics API
  version: 1.0.0
  description: API for retrieving user dashboard metrics including subscription usage and statistics

paths:
  /api/dashboard/metrics:
    get:
      summary: Get dashboard metrics for authenticated user
      description: Returns comprehensive dashboard data including subscription tier, usage limits, current usage, and user activity metrics
      security:
        - ClerkAuth: []
      responses:
        '200':
          description: Dashboard metrics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardMetrics'
              example:
                user:
                  id: "64a1b2c3d4e5f6g7h8i9j0k1"
                  displayName: "Dungeon Master Alex"
                  email: "alex@example.com"
                  subscriptionTier: "free"
                subscription:
                  tier: "free"
                  tierName: "Free Adventurer"
                  limits:
                    parties: 1
                    encounters: 3
                    creatures: 10
                  usage:
                    parties: 0
                    encounters: 2
                    creatures: 7
                  percentages:
                    parties: 0
                    encounters: 66.67
                    creatures: 70
                  warnings:
                    - resource: "encounters"
                      message: "You've used 2 of 3 encounters"
                      severity: "warning"
                    - resource: "creatures"
                      message: "You've used 7 of 10 creatures"
                      severity: "warning"
                metrics:
                  sessionsCount: 5
                  charactersCreatedCount: 3
                  campaignsCreatedCount: 1
                  lastLoginAt: "2025-10-25T10:30:00Z"
                  metricsLastUpdated: "2025-10-25T11:00:00Z"
        '401':
          description: Unauthorized - No valid Clerk session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Unauthorized"
                message: "You must be logged in to access dashboard metrics"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "InternalServerError"
                message: "Failed to retrieve dashboard metrics"

components:
  securitySchemes:
    ClerkAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Clerk authentication token from session

  schemas:
    DashboardMetrics:
      type: object
      required:
        - user
        - subscription
        - metrics
      properties:
        user:
          type: object
          required:
            - id
            - email
            - subscriptionTier
          properties:
            id:
              type: string
              description: User MongoDB ObjectId
            displayName:
              type: string
              nullable: true
              description: User display name (optional)
            email:
              type: string
              format: email
              description: User email address
            subscriptionTier:
              type: string
              enum: [free, seasoned, expert, master, guild]
              description: Current subscription tier
        subscription:
          type: object
          required:
            - tier
            - tierName
            - limits
            - usage
            - percentages
          properties:
            tier:
              type: string
              enum: [free, seasoned, expert, master, guild]
              description: Subscription tier identifier
            tierName:
              type: string
              description: Human-readable tier name
            limits:
              type: object
              required:
                - parties
                - encounters
                - creatures
              properties:
                parties:
                  type: integer
                  description: Maximum allowed parties
                encounters:
                  type: integer
                  description: Maximum allowed encounters
                creatures:
                  type: integer
                  description: Maximum allowed creatures
            usage:
              type: object
              required:
                - parties
                - encounters
                - creatures
              properties:
                parties:
                  type: integer
                  description: Current number of parties
                encounters:
                  type: integer
                  description: Current number of encounters
                creatures:
                  type: integer
                  description: Current number of creatures
            percentages:
              type: object
              required:
                - parties
                - encounters
                - creatures
              properties:
                parties:
                  type: number
                  format: float
                  description: Usage percentage for parties (0-100)
                encounters:
                  type: number
                  format: float
                  description: Usage percentage for encounters (0-100)
                creatures:
                  type: number
                  format: float
                  description: Usage percentage for creatures (0-100)
            warnings:
              type: array
              description: Usage warnings when approaching limits
              items:
                type: object
                required:
                  - resource
                  - message
                  - severity
                properties:
                  resource:
                    type: string
                    enum: [parties, encounters, creatures]
                  message:
                    type: string
                  severity:
                    type: string
                    enum: [info, warning, critical]
        metrics:
          type: object
          required:
            - sessionsCount
            - charactersCreatedCount
            - campaignsCreatedCount
          properties:
            sessionsCount:
              type: integer
              minimum: 0
              description: Total number of user sessions
            charactersCreatedCount:
              type: integer
              minimum: 0
              description: Total characters created by user
            campaignsCreatedCount:
              type: integer
              minimum: 0
              description: Total campaigns created by user
            lastLoginAt:
              type: string
              format: date-time
              nullable: true
              description: Timestamp of last login
            metricsLastUpdated:
              type: string
              format: date-time
              nullable: true
              description: Timestamp of last metrics update

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type/code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details (optional)
